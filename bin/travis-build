#!/usr/bin/env bash
set -e

if [[ "$ICECAVE_PUBLISH_COVERAGE" == "true" ]]; then
    REPO="$(pwd | sed s,^${HOME}/builds/,,g)"
    ./vendor/bin/phpunit-coverage
    ./vendor/bin/woodhouse github:publish \
        $REPO \
        test/report/coverage:coverage-report \
        --coverage-image coverage-report/coverage.png \
        --coverage-phpunit test/report/coverage.txt \
        --auth-token-env ICECAVE_GITHUB_TOKEN
else
    ./vendor/bin/phpunit
fi
