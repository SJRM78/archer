#!/usr/bin/env php
<?php
error_reporting(E_ALL | E_STRICT);

// Set some path constants ...
$rootPath = __DIR__ . '/../../../..';
$dotFilesPath = __DIR__ . '/../dotfiles';
$travisFilesPath = __DIR__ . '/../travis';

// See if a github token was provided ...
$token = $_SERVER['argc'] > 1 ? $_SERVER['argv'][1] : null;

// We want to publish coverage reports ...
if ($token) {
    echo 'Coverage reporting enabled, remember to add icecave/woodhouse to your dev dependencies!' . PHP_EOL;
    echo PHP_EOL;
    echo 'Encrypting token ...' . PHP_EOL;
    $exitCode = 0;
    $env = 'secure: ' . exec('travis encrypt --no-interactive ICECAVE_PUBLISH_COVERAGE="true" ICECAVE_GITHUB_TOKEN="' . $token . '"', $output, $exitCode);
    if ($exitCode != 0) {
        echo 'Unable to encrypt token...' . PHP_EOL;
        echo implode(PHP_EOL, $output);
        echo PHP_EOL;
        exit(1);
    }
    $travisConfig = file_get_contents($travisFilesPath . '/travis.coverage.yml');
    $travisConfig = str_replace('<coverage-env>', $env, $travisConfig);
} else {
    $travisConfig = file_get_contents($travisFilesPath . '/travis.yml');
}

echo 'Creating .travis.yml ...' . PHP_EOL;
file_put_contents($rootPath . '/.travis.yml', $travisConfig);

// Copy the dot files ...
foreach (scandir($dotFilesPath) as $filename) {
    $sourcePath = $dotFilesPath . '/' . $filename;
    $targetPath = $rootPath . '/.' . $filename;

    if (is_file($sourcePath)) {
        echo 'Creating .' . $filename . ' ...' . PHP_EOL;
        $content = file_get_contents($sourcePath);
        file_put_contents($targetPath, $content);
    }
}

echo PHP_EOL;
