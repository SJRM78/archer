set -e

if [[ "$TRAVIS_BRANCH" == "master" && `git branch -r` == *"gh-pages"* ]]; then

    # Get the repo name ...
    REPO="$(pwd | sed s,^${HOME}/builds/,,g)"

    # Get the PHP version ...
    PHP_VERSION=`php -r "echo phpversion();"`

    # Get the target path for coverage files ...
    COVERAGE_PATH="coverage-report"

    # Set git user ...
    git config --global user.email "travis@travis-ci.org"
    git config --global user.name "Travis CI"

    # Set upstream remote ...
    git remote add upstream https://${ICECAVE_GITHUB_TOKEN}@github.com/${REPO}.git

    # Copy reports ...
    cp -r test/report/coverage ${HOME}/${COVERAGE_PATH}

    echo "Checking out gh-pages branch ..."
    git checkout gh-pages
    echo

    echo "Removing existing coverage report ..."
    git rm -r --ignore-unmatch ${COVERAGE_PATH}
    echo

    echo "Copying new coverage report ..."
    mv ${HOME}/${COVERAGE_PATH} ${COVERAGE_PATH}
    git add -f ${COVERAGE_PATH}
    echo

    # Publish!
    echo "Comitting ..."
    git commit -m "Publishing coverage reports from build ${TRAVIS_BUILD_NUMBER} (php ${PHP_VERSION})."
    echo

    for ATTEMPT in 1 2 3; do
        echo "Push attempt #${ATTEMPT} ..."
        git pull
        if git push upstream gh-pages; [ $? = 0 ]; then
            exit 0
        fi
        sleep 2
        echo
    done

    exit 1
fi
